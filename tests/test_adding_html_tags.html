<html>

<head>
    <script src="/tag.js"></script>
</head>

<body>
    <plum-tree definition fruits="30">
        <style>
            plum-tree {
                display:block;
                position:relative;
                height:200px;
                width:200px;
            }
        </style>

        <definition-script>
            this.changed = function(name, oldVal, newVal) {
                if (name === "fruits") {
                    return this.drawFruits();
                }
            }

            this.drawFruits = function(desired) {
                var plums, remainingFruits, size;
                plums = this.getElementsByTagName("plum-fruit");
                remainingFruits = this.fruits - (plums.length);

                if (remainingFruits > 0) {
                    while (remainingFruits > 0) {
                        this.drawFruit();
                        remainingFruits--;
                    }
                } else if (remainingFruits < 0) {
                    while (remainingFruits < 0) {
                        this.removeChild(plums[0])
                        remainingFruits++;
                    }
                }
            }

            this.drawFruit = function() {
                tree = this;
                tag.create("plum-fruit").then(function (fruit) {
                    tree.appendChild(fruit);
                });
            }
        </definition-script>
    </plum-tree>

    <plum-fruit definition size="10">
        <style>
            plum-fruit {
                background-color:   purple;
                border-radius:      50%;
                color:              #fff;
                display:            block;
                height:             20px;
                line-height:        20px;
                position:           absolute;
                text-align:         center;
                transition:         all 1s ease-in-out;
                width:              20px;
            }
        </style>

        <definition-script>
            this.update = function (frame) {
                if(frame % 60 == 0) {
                    this.style.top = Math.random() * 100 + "%";    
                    this.style.left = Math.random() * 100 + "%";
                }
            };
        </definition-script>

        <template>o</template>
    </plum-fruit>

    <script>
        tag.assertEvents([
            ["definition-script", "def-started", 1],
            ["definition-script", "def-accepted", 1],
            ["plum-tree", "def-accepted", 1],
            ["plum-fruit", "def-accepted", 1],
            ["plum-fruit", "tag-attached", 50],
            ["plum-fruit", "prop-changed", 1]
        ], 1000).then(function(){
            t.id("tree").fruits = 5;
            t.name("plum-fruit")[0].size = 20;
            t.name("plum-fruit")[0].size = 25;

            tag.assertEqual(t.name("plum-fruit")[0].innerHTML, "o", "HTML template passed in and registered")

            tag.assertEvents([
                ["plum-fruit", "tag-removed", 45],
                ["plum-fruit", "prop-changed", 3]
            ])
        });
    </script>

    <plum-tree fruits="50" id="tree">
        <plum-fruit size="15"></plum-fruit>
        <div></div>
        <h1></h1>
    </plum-tree>
</body>
</html>
